import{_ as l,e as r,g as s,f as t,h as n,i,j as o,r as c,o as d}from"./app-Dnf0Sf9N.js";const p="/og-docs/images/gateway-action-lifecycle-light.png",u="/og-docs/images/gateway-action-lifecycle-dark.png",h={},m={class:"hint-container tip"};function g(v,e){const a=c("RouteLink");return d(),r("div",null,[e[26]||(e[26]=s("h1",{id:"gateway",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#gateway"},[s("span",null,"Gateway")])],-1)),s("p",null,[e[1]||(e[1]=n("The gateway is an Express.js app written in javascript that contains all the communication endpoints between the frontend and the engine. It also has direct communication with redis for caching state, with a postgresql DB to load seeds, persistante round states, and clear sessions. As stated in the introduction the gateway uses both a websocket connection for playing game rounds as well as http endpoints for various features such as clearing game session, getting user balance and others. See the ")),i(a,{to:"/api-docs/introduction.html"},{default:o(()=>e[0]||(e[0]=[n("API Docs")])),_:1}),e[2]||(e[2]=n(" for a full documentation of how to use all these endpoints."))]),e[27]||(e[27]=t('<h2 id="on-server-startup" tabindex="-1"><a class="header-anchor" href="#on-server-startup"><span>On Server Startup</span></a></h2><p>Below is a brief overview of what happens when the application starts:</p><ol><li><strong>Import and Configure:</strong> The app imports required dependencies (Express, WebSocket support, file-based routing, logging, etc.) and sets up logging (via Morgan)</li><li>Setsup <code>CORS</code> rules (supporting wildcards).</li><li><strong>Initialize External Services:</strong> Before creating the server, it attempts to connect to external services like NATS and Redis, and load game configuration defaults from Directus. If any critical initialization fails, the application logs the error and exits.</li><li><strong>Set Up Express:</strong> An Express instance is created, configured to parse JSON request bodies, and enhanced with WebSocket support.</li><li><strong>File-based Routing:</strong> The express-file-routing library is used to mount routes automatically, including potential WebSocket endpoints.</li><li><strong>Error Handling:</strong> A custom error-handling middleware is applied to catch and respond to errors gracefully.</li><li><strong>Server Listening:</strong> Finally, the app starts listening on the specified port, ready to accept incoming requests and WebSocket connections.</li></ol><h2 id="the-websocket" tabindex="-1"><a class="header-anchor" href="#the-websocket"><span>The Websocket</span></a></h2><h3 id="high‚Äêlevel-overview" tabindex="-1"><a class="header-anchor" href="#high‚Äêlevel-overview"><span>High‚ÄêLevel Overview</span></a></h3>',5)),s("ol",null,[e[8]||(e[8]=t("<li>Client opens a WebSocket connection to the server.</li><li>Server initializes a <strong>Session</strong> object to handle authentication and game‚Äêrelated data (including round state, player seeds, etc.).</li><li>The client <strong>Authenticates</strong> by sending a message of type <code>Authenticate</code>. Once authenticated, the session is stored in a Map of active WebSocket connections.</li><li>Subsequent client actions flow through the <strong><code>RoundEvent</code> class</strong>, which identifies the appropriate game logic and <strong>publishes</strong> the action to an internal event bus (NATS) if needed.</li>",4)),s("li",null,[e[4]||(e[4]=n("The game service (in another process) consumes these actions from NATS, processes the game logic, and ")),e[5]||(e[5]=s("strong",null,"publishes updates back",-1)),e[6]||(e[6]=n(" to the same NATS event bus. See ")),i(a,{to:"/full-documentation/gameservice.html"},{default:o(()=>e[3]||(e[3]=[n("gameservice")])),_:1}),e[7]||(e[7]=n(" for more details on this process."))]),e[9]||(e[9]=s("li",null,[n("The gateway (through the Session instance) "),s("strong",null,"consumes these updates"),n(", updates the round state attached to the consumed message, and pushes the updates back to the client over the same WebSocket. The "),s("code",null,"RoundUpdate"),n(" class is responsible for performing these tasks.")],-1))]),e[28]||(e[28]=t('<h3 id="lifecycle-of-a-websocket-action" tabindex="-1"><a class="header-anchor" href="#lifecycle-of-a-websocket-action"><span>Lifecycle of a websocket action:</span></a></h3><p><img src="'+p+'" alt="websocket Action Lifecycle" data-mode="lightmode-only" loading="lazy"><img src="'+u+`" alt="websocket Action Lifecycle" data-mode="darkmode-only" loading="lazy"></p><ul><li><strong>Top half (<code>RoundEvent</code>):</strong> Client‚Äôs action request is identified, validated, published to the game service via NATS, and eventually triggers game updates.</li><li><strong>Bottom half (<code>RoundUpdate</code>):</strong> The game update is consumed, validated, triggers local state updates (potentially calls platform transactions), stores the updated round state, and sends the response back to the client.</li></ul><h3 id="key-libraries-and-their-roles" tabindex="-1"><a class="header-anchor" href="#key-libraries-and-their-roles"><span>Key Libraries and Their Roles</span></a></h3><ol><li><strong>Express.js:</strong> Even though the code references Express.js at a high level, the actual WebSocket upgrade handling is done via a custom route or a library that ties into Express.</li><li><strong>ws (WebSocket library):</strong> The code in <code>export const ws = async (ws, req) =&gt; { ... }</code> uses typical <code>ws</code> library‚Äìstyle callbacks <code>ws.on(&#39;message&#39;, ...)</code>, <code>ws.on(&#39;close&#39;, ...)</code> etc ...</li><li><strong>NATS (JetStream / nats.js):</strong><ul><li>Used to publish client actions to downstream game services (publishAction in RoundEvent) and to consume game updates.</li><li>The Session class sets up ‚Äúconsumers‚Äù and ‚Äúmessage iterators,‚Äù so each session can listen to updates intended for that specific game session.</li></ul></li><li><strong>Redis:</strong><ul><li>Holds the latest round state and seed data for each player, ensuring a consistent single source of truth.</li><li>The code frequently checks Redis for any existing round state to keep the front end in sync.</li></ul></li><li><strong>Big.js:</strong><ul><li>Used to handle potentially large or precise numeric calculations, particularly around bet amounts, payouts, etc.</li></ul></li><li><strong>Joi:</strong><ul><li>Used in <code>RoundEvent</code> to validate incoming messages from the client (the shape of JSON, required fields, allowed values, etc.).</li></ul></li></ol><h3 id="detailed-flow" tabindex="-1"><a class="header-anchor" href="#detailed-flow"><span>Detailed Flow</span></a></h3><h3 id="_1-websocket-entrypoint" tabindex="-1"><a class="header-anchor" href="#_1-websocket-entrypoint"><span>1. WebSocket Entrypoint</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">ws</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ws<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Purpose:</strong> The main gateway that handles all incoming WebSocket messages from the client.</p><p><strong>Session Creation:</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">let</span> session</span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Session</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>game_session_id<span class="token punctuation">,</span> ws<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>A new Session object is constructed, which sets up an internal representation of the user‚Äôs state and identifies them via <code>game_session_id</code>.</li><li>If no <code>game_session_id</code> is provided, a GameError is thrown and the WebSocket is immediately closed.</li></ul><p><strong>Message Handling:</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// parse JSON</span></span>
<span class="line">    <span class="token comment">// authenticate session</span></span>
<span class="line">    <span class="token comment">// load &amp; update round state</span></span>
<span class="line">    <span class="token comment">// instantiate a dynamic &quot;RoundEvent&quot; class for the chosen game</span></span>
<span class="line">    <span class="token comment">// publish to NATS if needed</span></span>
<span class="line">    <span class="token comment">// catch any errors and send them back to the client</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Authentication:</strong></p>`,15)),s("ul",null,[s("li",null,[e[13]||(e[13]=n("The very first message of type ")),e[14]||(e[14]=s("code",null,"Authenticate",-1)),e[15]||(e[15]=n(" triggers ")),e[16]||(e[16]=s("code",null,"await session.authenticate()",-1)),e[17]||(e[17]=n(". See ")),i(a,{to:"/api-docs/websocket-guide.html"},{default:o(()=>e[10]||(e[10]=[n("websocket guide")])),_:1}),e[18]||(e[18]=n(" for details on payload schemas. ")),s("ul",null,[s("li",null,[e[12]||(e[12]=n("The authentication steps are descibed below in ")),i(a,{to:"/full-documentation/gateway.html#_2-session-management-session-js"},{default:o(()=>e[11]||(e[11]=[n("the session manager section")])),_:1})])])]),e[19]||(e[19]=s("li",null,"On success, the session is registered in a Map (wsClients) so the server knows this client is authenticated.",-1)),e[20]||(e[20]=s("li",null,"A ‚Äúsuccessful authentication‚Äù confirmation is sent back to the client.",-1))]),e[29]||(e[29]=t(`<p><strong>Subsequent Actions:</strong></p><p>on any request that comes in after authentication:</p><ul><li>We check that the client is authenticated (<code>wsClients.has(session.gameSessionId)</code>). If not, it‚Äôs an error.</li><li>We locate the correct <code>RoundEvent</code> subclass from <code>gameClass[msg?.gameId]?.event</code></li><li>Retrieve the latest round state from Redis:</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> _<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> event<span class="token punctuation">.</span><span class="token function">getGameState</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">state <span class="token operator">?</span> session<span class="token punctuation">.</span>state <span class="token operator">=</span> state <span class="token operator">:</span> session<span class="token punctuation">.</span><span class="token function">resetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Call <code>event.handleEvent()</code> to process the request. Any resulting payload gets sent back over the WebSocket.</li></ul><p><strong>Connection Close Handling</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// remove session from list of live sessions</span></span>
<span class="line">    wsClients<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>gameSessionId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Cleans up resources, removes the client from the active sessions Map, and triggers session teardown logic (closing the consumer, etc.) as explained above.</li></ul><h3 id="_2-session-management-session-js" tabindex="-1"><a class="header-anchor" href="#_2-session-management-session-js"><span>2. Session Management (<code>session.js</code>)</span></a></h3><p><strong>Constructor</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">gameSessionId<span class="token punctuation">,</span> wsConnection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>wsConnection <span class="token operator">=</span> wsConnection</span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>gameSessionId <span class="token operator">=</span> gameSessionId</span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">metadata</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">game_session_id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gameSessionId <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Stores initial metadata (player/game session IDs) in <code>this.state</code>.</li></ul><p><strong>üîë authenticate()</strong></p>`,13)),s("div",m,[e[25]||(e[25]=s("p",{class:"hint-container-title"},"What authenticating a session does:",-1)),s("ol",null,[s("li",null,[e[22]||(e[22]=n("Calls into Platform see ")),i(a,{to:"/full-documentation/platform-api-guide.html"},{default:o(()=>e[21]||(e[21]=[n("guide to platrofm API")])),_:1}),e[23]||(e[23]=n(" to validate the player‚Äôs credentials."))]),e[24]||(e[24]=t("<li>Sets up the NATs consumer via <code>initialiseSessionConsumer()</code>. Each session creates a specialized consumer that listens for updates intended for that particular <code>gameSessionId</code>.</li><li>Subscribes to consumer deletion events via <code>RestartConsumerOnDeletion()</code>. If the consumer is ever deleted behind the scenes, it automatically recreates it.</li><li>Seeds: Calls <code>loadSeeds()</code>, which either retrieves the seeds from the DB or generates new ones if none exist, then caches them in Redis.</li><li>Adds a <code>ws</code> callback on <code>close</code> in order to shutdown consumer, close subscriptions and delete cache when client disconnects</li>",4))])]),e[30]||(e[30]=t(`<p><strong>NATS Consumer Lifecycle</strong></p><ul><li><code>initialiseSessionConsumer()</code>: Ensures the required JetStream stream is present, adds a consumer for this.<code>gameSessionId</code>, and starts an async iterator to consume messages.</li><li><code>RestartConsumerOnDeletion()</code>: Watches for the <code>$JS.EVENT.ADVISORY.CONSUMER.DELETED.&lt;streamName&gt;.&lt;gameSessionId&gt;</code> subject; if triggered, the consumer is re‚Äêinitialized.</li><li><code>removeSessionConsumer():</code> Cleans up the consumer on WebSocket close.</li></ul><p><strong>handleGameResponse</strong></p><p>Once a consumer is created from the above <code>initialiseSessionConsumer</code>, a consumer callback function is required in order for NATs to do something with the messages that are being consumed. Thats where the <code>handleGameresponse</code> callback comes in:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function-variable function">handleGameResponse</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">subject<span class="token punctuation">,</span> rawMessage</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// parse the message JSON</span></span>
<span class="line">    <span class="token comment">// find the correct RoundUpdate class for the game</span></span>
<span class="line">    <span class="token comment">// call handleUpdate()</span></span>
<span class="line">    <span class="token comment">// update the session&#39;s state</span></span>
<span class="line">    <span class="token comment">// send the result to the client</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>This method is invoked when the game service publishes updates for the specific <code>&lt;gameSessionId&gt;</code>, and gateway consumer reads it.</li><li>A <code>RoundUpdate</code> subclass is instantiated; it handles the logic for the update message, sending payouts, saves updated state to memory &amp; cache.</li><li>Finally, the update is forwarded to the client‚Äôs WebSocket via update.send(this.wsConnection).</li></ul><p><strong>resetState():</strong></p><ul><li>Clears out everything in <code>session.state</code> except for metadata. That is needed when the round closes.</li></ul><h3 id="_3-game-event-handling-roundevent-class" tabindex="-1"><a class="header-anchor" href="#_3-game-event-handling-roundevent-class"><span>3. Game Event Handling (RoundEvent Class)</span></a></h3><div class="hint-container info"><p class="hint-container-title">When the client sends an action (e.g., ‚ÄúOpen,‚Äù ‚ÄúHit,‚Äù ‚ÄúStand,‚Äù etc.), the <code>RoundEvent</code> class is used to:</p><ol><li>Validate incoming JSON (via <code>Joi</code>).</li><li>Ensure the user has sufficient funds (for betting) if needed.</li><li>Publish the action to NATS so that the actual game service can process it asynchronously.</li><li>Update state nonce</li></ol></div><h4 id="validateinputs" tabindex="-1"><a class="header-anchor" href="#validateinputs"><span>validateInputs()</span></a></h4><ul><li>Uses a <code>Joi</code> schema (<code>gameEventSchema</code>) to ensure the message shape is correct, verifying fields like type, action, <code>gameId</code>, and data.</li></ul><h4 id="handleevent" tabindex="-1"><a class="header-anchor" href="#handleevent"><span>handleEvent()</span></a></h4><p>There are 2 possible event types for the websocket (apart from <code>Authenticate</code>): <code>RoundState</code> &amp; <code>RoundAction</code></p><ul><li>If it‚Äôs <code>RoundAction</code>, it tries to set an idempotent key so the same action doesn‚Äôt get processed multiple times.</li><li>Publishes the event to NATS (via <code>publishAction()</code>).</li><li>If it‚Äôs <code>RoundState</code>, it returns the entire game state from the server/Redis (for instance, if the client wants to re‚Äêfetch the current round state).</li></ul><h4 id="publishaction" tabindex="-1"><a class="header-anchor" href="#publishaction"><span>publishAction()</span></a></h4><ul><li>Publishes to the correct NATS subject (based on the <code>gameId</code>).</li><li>Retries a few times if the stream or JetStream manager is temporarily unavailable.</li></ul><h4 id="getgamestate" tabindex="-1"><a class="header-anchor" href="#getgamestate"><span>getGameState()</span></a></h4><ul><li>Fetches the current round state from Redis. If not found, tries the database.</li><li>This ensures the server‚Äôs memory is consistent with the shared store in Redis or the DB.</li></ul><h3 id="_4-game-updates-roundupdate-class" tabindex="-1"><a class="header-anchor" href="#_4-game-updates-roundupdate-class"><span>4. Game Updates (RoundUpdate Class)</span></a></h3><div class="hint-container info"><p class="hint-container-title">When the <code>gameservice</code> publishes an update for a given round, a <code>RoundUpdate</code> object is created to:</p><ol><li>Validate the update message.</li><li>Create neccesary transaction to the platform API</li><li>Send the relevant update to the client.</li></ol></div><h4 id="key-methods" tabindex="-1"><a class="header-anchor" href="#key-methods"><span>Key Methods:</span></a></h4><p><strong>constructor():</strong></p><ul><li>Extracts the state, update, roundId, and actionId from the incoming message.</li></ul><p><strong>handleUpdate():</strong></p><ul><li>Checks if the round has already been closed. If so, runs onRoundClosed().</li><li>Ensures we strip out any server‚Äêonly metadata from the data we send to the client.</li></ul><p><strong>onRoundClosed():</strong></p><ul><li>Potentially sends a payout transaction to the platform if total_payout &gt; 0.</li><li>Resets the round state in Redis and in the Session.</li></ul><p><strong>cacheState():</strong></p><ul><li>Writes the updated round state to Redis (so that subsequent requests see the newest data).</li><li>send(client):</li><li>Sends the final or intermediate update to the client‚Äôs WebSocket.</li></ul><h3 id="putting-it-all-together-referencing-the-diagram" tabindex="-1"><a class="header-anchor" href="#putting-it-all-together-referencing-the-diagram"><span>Putting It All Together (Referencing the Diagram)</span></a></h3><ol><li><strong>Client Action Request</strong><ul><li>The front‚Äêend calls the WebSocket with JSON: <code>{ type: &quot;RoundAction&quot;, action: &quot;Bet&quot;, gameId: &quot;...&quot;, data: {...} }</code>.</li><li>The server identifies the game and uses <code>RoundEvent</code> Class to parse and validate the request.</li></ul></li><li><strong>Load Current Round State</strong><ul><li><code>event.getGameState()</code> checks Redis to see if a round is currently open, merges it into the Session.</li></ul></li><li><strong>Validate Request‚Äôs Action</strong><ul><li>For example, if the action is ‚ÄúBet,‚Äù verify the user‚Äôs balance.</li></ul></li><li><strong>Publish to Game Service</strong><ul><li>After the server decides the request is valid, it uses NATS to publish the action to the back‚Äêend game microservice.</li></ul></li><li><strong>Consume Game Updates</strong><ul><li>The gameservice processes the action, calculates the next game state, and publishes an update event to the same NATS stream. (<strong>also publishes the new state</strong>)</li><li>The server‚Äôs Session has an open JetStream consumer that receives that update.</li></ul></li><li><strong>Identify Game &amp; Validate Metadata</strong><ul><li>The server receives the update message, picks the right RoundUpdate class, and checks the round data.</li></ul></li><li><strong>Call Platform Transactions (if needed)</strong><ul><li>If the update says ‚ÄúRound Closed, user won X,‚Äù the server calls Platform to process the payout.</li></ul></li><li><strong>Update Round State in Redis</strong><ul><li>The updated data is written to Redis for persistent caching.</li></ul></li><li><strong>Respond to Client</strong><ul><li>Finally, the server sends the final or intermediate update (new cards, new totals, a ‚Äúround closed‚Äù message, etc.) back to the client‚Äôs WebSocket.</li></ul></li></ol><h3 id="important-details-to-note" tabindex="-1"><a class="header-anchor" href="#important-details-to-note"><span>Important Details to Note</span></a></h3><ul><li><strong>Idempotency:</strong></li></ul><p>In <code>RoundEvent.handleEvent()</code>, there is a check for duplicates using an idempotent key (<code>setIdempotentKey(this.actionId)</code>). This prevents double‚Äêexecuting the same action.</p><ul><li><strong>Session Ties:</strong></li></ul><p>Each WebSocket connection is tied to exactly one Session. When the connection closes, the session is cleaned up (closing its NATS subscription, etc.).</p><ul><li><strong>Redis as a Synchronization Layer:</strong></li></ul><p>Round states are not stored only in memory but also in Redis. This ensures that if a user opens another browser tab or the server restarts, the state remains consistent.</p><ul><li><strong>Error Handling:</strong></li></ul><p>Custom <code>GameError</code> objects are thrown throughout the code, ensuring consistent error messages to the client with an understandable structure (including error codes, descriptions, and references to the relevant <code>eventId</code>).</p><ul><li><strong>Platform Interaction:</strong></li></ul><p>The Platform class is used throughout the gateway to handle outside calls (authentication or transaction/payout).</p><ul><li><strong>NATS Consumer Lifecycle:</strong></li></ul><p>Each session has a dedicated consumer. If the consumer is ever deleted abruptly or the server restarts, <code>RestartConsumerOnDeletion()</code> ensures it will be recreated.</p>`,45))])}const k=l(h,[["render",g],["__file","gateway.html.vue"]]),f=JSON.parse('{"path":"/full-documentation/gateway.html","title":"Gateway","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"On Server Startup","slug":"on-server-startup","link":"#on-server-startup","children":[]},{"level":2,"title":"The Websocket","slug":"the-websocket","link":"#the-websocket","children":[{"level":3,"title":"High‚ÄêLevel Overview","slug":"high‚Äêlevel-overview","link":"#high‚Äêlevel-overview","children":[]},{"level":3,"title":"Lifecycle of a websocket action:","slug":"lifecycle-of-a-websocket-action","link":"#lifecycle-of-a-websocket-action","children":[]},{"level":3,"title":"Key Libraries and Their Roles","slug":"key-libraries-and-their-roles","link":"#key-libraries-and-their-roles","children":[]},{"level":3,"title":"Detailed Flow","slug":"detailed-flow","link":"#detailed-flow","children":[]},{"level":3,"title":"1. WebSocket Entrypoint","slug":"_1-websocket-entrypoint","link":"#_1-websocket-entrypoint","children":[]},{"level":3,"title":"2. Session Management (session.js)","slug":"_2-session-management-session-js","link":"#_2-session-management-session-js","children":[]},{"level":3,"title":"3. Game Event Handling (RoundEvent Class)","slug":"_3-game-event-handling-roundevent-class","link":"#_3-game-event-handling-roundevent-class","children":[]},{"level":3,"title":"4. Game Updates (RoundUpdate Class)","slug":"_4-game-updates-roundupdate-class","link":"#_4-game-updates-roundupdate-class","children":[]},{"level":3,"title":"Putting It All Together (Referencing the Diagram)","slug":"putting-it-all-together-referencing-the-diagram","link":"#putting-it-all-together-referencing-the-diagram","children":[]},{"level":3,"title":"Important Details to Note","slug":"important-details-to-note","link":"#important-details-to-note","children":[]}]}],"git":{"updatedTime":1743073778000,"contributors":[{"name":"cybeni","username":"cybeni","email":"mail2048@pm.me","commits":4,"url":"https://github.com/cybeni"}],"changelog":[{"hash":"851aa99b39db587b5f41b9bfbab89e5879361dd2","date":1743073778000,"email":"mail2048@pm.me","author":"cybeni","message":"minor adjustments","commitUrl":"https://github.com/bernardcosta/Tangiers/commit/851aa99b39db587b5f41b9bfbab89e5879361dd2"},{"hash":"9db8bbb5151a8792f6d10258040a420daeda85df","date":1741880678000,"email":"mail2048@pm.me","author":"cybeni","message":"wip","commitUrl":"https://github.com/bernardcosta/Tangiers/commit/9db8bbb5151a8792f6d10258040a420daeda85df"},{"hash":"76330b034827f1c47446a118c5ab28ea235c9ce8","date":1741878621000,"email":"mail2048@pm.me","author":"cybeni","message":"wip","commitUrl":"https://github.com/bernardcosta/Tangiers/commit/76330b034827f1c47446a118c5ab28ea235c9ce8"},{"hash":"e38bd8c1175667b60f6f86d2599a5d8b66565ac4","date":1741707461000,"email":"mail2048@pm.me","author":"cybeni","message":"wip","commitUrl":"https://github.com/bernardcosta/Tangiers/commit/e38bd8c1175667b60f6f86d2599a5d8b66565ac4"}]},"filePathRelative":"full-documentation/gateway.md"}');export{k as comp,f as data};
